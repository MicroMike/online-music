<!doctype html>
<html>

<head>
  <title>Socket.IO chat</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    #errs,
    #servers {
      display: flex;
    }

    #errs > span,
    #servers > span {
      flex: 0;
      border-right: 1px solid black;
      padding: 5px;
      text-align: center;
    }

    [id^="players-"] {
      position: relative;
    }

    [id^="players-"] div {
      position: absolute;
      top: 0;
      left: 0;
      width: 0%;
      max-width: 100%;
      height: 100%;
      background: lightskyblue;
      z-index: -1;
      transition: width 5s;
    }
  </style>
  <script type="text/javascript">
    var socket = io();

    const screenshot = id => {
      socket.emit('screenshot', id)
    }

    const clearErrs = id => {
      socket.emit('clearErrs')
    }

    const getData = () => {
      socket.emit('getAllData')
    }

    const clearData = () => {
      socket.emit('clearData')
    }

    const restart = (id = null) => {
      socket.emit('restart', id)
    }

    const stop = (id = null) => {
      socket.emit('stop', id)
    }

    const spotifyPause = () => {
      socket.emit('spotifyPause')
    }

    const clearScreen = () => {
      document.querySelector('.screenshot').innerHTML = ''
      socket.emit('clearScreen')
    }

    const check = () => {
      socket.emit('check')
    }

    const endCheck = () => {
      socket.emit('endCheck')
    }

    socket.on('activate', () => {
      socket.emit('web')
    })

    socket.on('clean', () => {
      document.querySelector('.screenshot').innerHTML = ''
      document.querySelector('.players').innerHTML = ''
      document.querySelector('.freezedPlayers').innerHTML = ''
      document.querySelector('.others').innerHTML = ''
    })

    socket.on('allData', data => {
      const clients = data.clients
      const errs = data.errs
      delete data.clients
      delete data.errs

      document.querySelector('#data').innerHTML = ''
      document.querySelector('#servers').innerHTML = ''
      document.querySelector('#errs').innerHTML = ''

      Object.keys(clients).forEach((k, i) => {
        const val = clients[k]
        // document.querySelector('#servers').insertAdjacentHTML('beforeend', `<span>${i} => ${d.L} <button id="R_${d.id}" onclick="restart('${d.id}')">R</button></span>`)
        document.querySelector('#servers').insertAdjacentHTML('beforeend', `<span>${k} => ${val}<button id="R_${k}" onclick="restart('${k}')">R</button></span>`)
      })

      Object.keys(errs).forEach((k, i) => {
        const val = errs[k]
        document.querySelector('#errs').insertAdjacentHTML('beforeend', `<span>${k} => ${val}</span>`)
      })

      // <button onClick="stop('${d.id}')">S</button>

      Object.keys(data).forEach(k => {
        let d = data[k]
        document.querySelector('#data').insertAdjacentHTML('beforeend', `<div>${k} => ${d}</div>`)
      })
    })

    socket.on('endStream', streamId => {
      const isDom = document.querySelector('#class' + streamId)
      isDom && isDom.parentElement.remove()
    })

    const toggleBtn = btn => {
      socket.emit(btn.innerText, btn.className)
      btn.innerText = btn.innerText === 'streamOn' ? 'streamOff' : 'streamOn'
    }

    const runScript = btn => {
      const scriptText = document.querySelector('#script' + btn.className).value
      socket.emit('runScript', { id: btn.className, scriptText })
    }

    socket.on('clearStream', (delList) => {
      document.querySelector('#del').innerHTML = delList
    })

    socket.on('delList', (delList) => {
      document.querySelector('#del').innerHTML = delList
    })

    socket.on('stream', ({ streamOn, streamId, log, img }) => {
      const isDom = document.querySelector('#class' + streamId)
      const streamBtn = streamOn ? 'streamOff' : 'streamOn'
      const html = img
        ? `<div>
            <h2>${log} :</h2>
            <img id="class${streamId}" src="data:image/png;base64,${img}"/>
            <button id="btn${streamId}" class="${streamId}" onclick="toggleBtn(this)">${streamBtn}</button>
            <textarea id="script${streamId}"></textarea>
            <button id="btnScript${streamId}" class="${streamId}" onclick="runScript(this)">Run script</button>
          </div>`
        : `<div>
            <h2>${log} :</h2>
          </div>`
      if (!isDom) {
        document.querySelector('.screenshot').insertAdjacentHTML('beforeEnd', html)
      }
      else {
        isDom.src = 'data:image/png;base64,' + img
      }
    })

    const displayPlays = (p) => {
      let { account, time, streamId, freeze, other, out, ok, nope, warn } = p
      time = time || 0

      const isDomF = document.querySelector('.freezedPlayers #players-' + streamId)
      const isDomOk = document.querySelector('.players #players-' + streamId)
      const isOthers = document.querySelector('.others #players-' + streamId)
      const isNope = document.querySelector('body > #players-' + streamId)

      const insideHtml = `<div style="width:${time}%;"></div><span style="color:${(warn && 'orange') || (freeze && 'red')};">${account} : ${time}</span><button onClick="screenshot('${streamId}')"></button>`
      const html = `<div id="players-${streamId}" ${freeze && `class="freeze"`}>${insideHtml}</div>`

      !ok && isDomOk && isDomOk.remove()
      !freeze && isDomF && isDomF.remove()
      !other && isOthers && isOthers.remove()
      !nope && isNope && isNope.remove()

      const dom = document.querySelector('#players-' + streamId)
      if (out) { return dom && dom.remove() }

      if (dom) {
        const currentTime = document.querySelector('#players-' + streamId + ' div').style.width.replace('%', '')
        if (time > currentTime) {
          document.querySelector('#players-' + streamId + ' span').innerText = `${account} : ${time}`
          document.querySelector('#players-' + streamId + ' div').style.width = time + '%'
        }
        else {
          dom.innerHTML = insideHtml
        }
      }
      else {
        other && document.querySelector('.others').insertAdjacentHTML('afterBegin', html)
        ok && document.querySelector('.players').insertAdjacentHTML('afterBegin', html)
        freeze && document.querySelector('.freezedPlayers').insertAdjacentHTML('afterBegin', html)
        nope && document.querySelector('body').insertAdjacentHTML('afterBegin', html)
      }

      const count = document.querySelectorAll('[id^=players-]').length
      document.querySelector('#count').innerText = count
    }

    socket.on('playerInfos', streams => {
      streams.forEach(s => s && displayPlays(s))
    })
  </script>
</head>

<body>
  <div id="servers"></div>
  <div id="errs"></div>
  <div id="data"></div>
  <button onClick="restart()">RESTART</button>
  <button onClick="clearScreen()">CLEAR SCREENSHOT</button>
  <button onClick="clearErrs()">CLEAR ERRORS</button>
  <button onClick="getData()">GET DATA</button>
  <div id="del"></div>
  <div id="count"></div>
  <div style="display: flex;">
    <div class="players"></div>
    <div class="freezedPlayers"></div>
    <div class="others"></div>
  </div>
  <div class="screenshot"></div>
</body>

</html>