<!doctype html>
<html>

<head>
  <title>Socket.IO chat</title>
  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">
    var socket = io();

    const reset = () => {
      socket.emit('reset')
    }

    const run = () => {
      socket.emit('run')
    }

    const stop = () => {
      socket.emit('stop')
    }

    const spotifyPause = () => {
      socket.emit('spotifyPause')
    }

    const clearScreen = () => {
      document.querySelector('.screenshot').innerHTML = ''
      socket.emit('clearScreen')
    }

    const check = () => {
      socket.emit('check')
    }

    const endCheck = () => {
      socket.emit('endCheck')
    }

    socket.on('activate', () => {
      socket.emit('web')
    })

    socket.on('endStream', streamId => {
      const isDom = document.querySelector('#class' + streamId)
      isDom && isDom.parentElement.remove()
    })

    const toggleBtn = btn => {
      socket.emit(btn.innerText, btn.className)
      btn.innerText = btn.innerText === 'streamOn' ? 'streamOff' : 'streamOn'
    }

    const runScript = btn => {
      const scriptText = document.querySelector('#script' + btn.className).value
      socket.emit('runScript', { id: btn.className, scriptText })
    }

    socket.on('clearStream', (delList) => {
      document.querySelector('#del').innerHTML = delList
    })

    socket.on('delList', (delList) => {
      document.querySelector('#del').innerHTML = delList
    })

    socket.on('stream', ({ streamOn, streamId, log, img }) => {
      const isDom = document.querySelector('#class' + streamId)
      const streamBtn = streamOn ? 'streamOff' : 'streamOn'
      if (!isDom) {
        document.querySelector('.screenshot').insertAdjacentHTML('beforeEnd', `
          <div>
            <h2>${log} :</h2>
            <img id="class${streamId}" src="data:image/png;base64,${img}"/>
            <button id="btn${streamId}" class="${streamId}" onclick="toggleBtn(this)">${streamBtn}</button>
            <textarea id="script${streamId}"></textarea>
            <button id="btnScript${streamId}" class="${streamId}" onclick="runScript(this)">Run script</button>
          </div>
        `)
      }
      else {
        isDom.src = 'data:image/png;base64,' + img
      }
    })
  </script>
</head>

<body>
  <button onClick="reset()">RESET</button>
  <button onClick="run()">RUN</button>
  <button onClick="stop()">STOP</button>
  <button onClick="clearScreen()">CLEAR SCREENSHOT</button>
  <button onClick="check()">CHECK</button>
  <button onClick="endCheck()">END CHECK</button>
  <button onClick="spotifyPause()">SPOTIFY ON</button>
  <div id="del"></div>
  <div class="screenshot"></div>
</body>

</html>